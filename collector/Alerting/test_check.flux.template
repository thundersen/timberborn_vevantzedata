import "experimental"
import "influxdata/influxdb/monitor"
import "influxdata/influxdb/v1"

settlement = "$SETTLEMENT$"
check_duration = 2d

lastTime = (tables=<-) => {
    extract = tables
        |> last()
        |> findColumn(fn: (key) => true, column: "_time")

    return extract[0]
}

stop = from(bucket: "vevantzedata")
    |> range(start: 2100-01-01T00:00:00Z, stop: 2200-01-01T00:00:00Z)
    |> filter(fn: (r) => r["_measurement"] == "stocks")
    |> filter(fn: (r) => r["settlement"] == settlement)
    |> filter(fn: (r) => r["_field"] == "Berries")
    |> lastTime()

start = experimental.subDuration(d: check_duration, from: stop)

from(bucket: "vevantzedata")
    |> range(start: start, stop: stop)
    |> filter(fn: (r) => r["_measurement"] == "stocks")
    |> filter(fn: (r) => r["settlement"] == settlement)
    |> filter(fn: (r) => r["_field"] == "Berries")
    |> aggregateWindow(every: check_duration, fn: mean, createEmpty: false)
    |> last()